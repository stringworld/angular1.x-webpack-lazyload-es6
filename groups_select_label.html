<!DOCTYPE html>
<html ng-app="labelList">

<head>
    <meta charset="UTF-8">
    <title>批量添加标签</title>

    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,minimal-ui">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">

    <script src="http://www.angularjsapi.cn/angular-1.3.0.14/angular.js"></script>
    <script src="http://cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script>
    <script src="js/rem.js"></script>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/list.css">
    <!--<link rel="stylesheet" href="http://apps.bdimg.com/libs/bootstrap/3.3.0/css/bootstrap.min.css">-->
    <style>
        .content li {
            height: 1.7rem;
        }
        #labelContrlList{
        }
    </style>
</head>

<body ng-controller="labelContrlList">
    <div>
        <!--<div class="top-nbsp"></div>
        <p class="navigation-top fixed-top">
            <a href="" onclick="history.go(-1)" class="left"></a>
            批量添加标签
        </p>-->
        <ul class="content" id="labelContrlList">
            <li ng-repeat="labelValue in label_data_json">
                <span class="content_photo_"><img class="content_photo" ng-src={{labelValue.label_src}} onerror="this.src='images/me_default.png'"></span>
                <span class="content_txt">
                    <p class="content_title">
                        <span ng-bind="labelValue.label_title"></span>
                        <span class="label_checkbox" ng-click="show_tick($event,$index)">
                            <!--<img ng-show={{labelValue.label_tick}} src="./images/check_tick.png" alt="对号"/>-->
                            <img ng-src="./images/check_{{labelValue.label_tick}}.png"/>
                        </span>
                    </p>
                    <p class="content_address" ng-bind="labelValue.label_address"></p>
                    <p class="content_list_label">
                        <span class="content_label" ng-repeat="labelTxt in labelValue.babel_txt" ng-bind="labelTxt"></span>
                    </p>
                </span>
            </li>
            <!--<div class="no-items" ng-show="pageNumber <= 0">暂无数据</div>-->
        </ul>
        <div class="bottom-nbsp">
            <span class="page_num">
                <span class="left_arrow left" ng-class="{active:currentPage == 1}"  ng-click="setChange(currentPage=currentPage-1)">&#139</span><!--&#139   &#60;-->
                <span style="font-size: 0.28rem;color:#9B9B9B;"><b ng-bind="currentPage"></b>/<b ng-bind="pageNumber"></b></span>
                <span class="right_arrow right" ng-class="{active:currentPage == pageNumber}" ng-click="setChange(currentPage=currentPage+1)">&#155</span><!--&#155    >-->
            </span>
            <span class="label_checkboxed">已选中 <span id="label_checkboxed" ng-bind="count"></span> 位</span>
            <span class="right" ng-class="{active_bg:count<=0}" id="label_value_add" ng-click="label_value_add()">添加标签</span>
        </div>
    </div>
    <script src="./js/rem.js"></script>
    <script src="js/get_label_width.js"></script>
    <script src="js/bridge.js"></script>
    <script src="js/lazy.js"></script>
    <script>
        window.onload=function(){
            // $bridge.RegisterFunction("testh5");
            // $bridge.callMobile("changeTitle", link_)



            var link_=JSON.stringify({'params':'批量添加标签'});
            $bridge.callMobile("changeTitle", link_);
            save_status(0)
            $bridge.callMobile("finishSelect", 'ok');

            // $bridge.callMobile("userData");

            // function testh5(userData){
            //     var userData = JSON.stringify(userData);
            //     alert(userData)
            // }
        
        }
            
        function save_status(status){
            var save_status=JSON.stringify({'type':status});
            $bridge.callMobile("rightBtn", save_status);
        }

        var data_json=[];
        var data_json_status=[];    //保存原数据用户操作的每一页选择的状态,选中的患者


            var userData=GetUrlValue("userData");
            var relationType=GetUrlValue("relationType");
            // alert(relationType)
            var this_cookie;
            if(userData){
                this_cookie='SESSION='+userData;
            }else{
                this_cookie=document.cookie;
            }

    var app=angular.module('labelList',[]);
    app.controller('labelContrlList',function($scope,$http){
        var and = browser.versions.android;

        $bridge.RegisterFunction("post_all_label_value");

        //显示数值
        $scope.label_data_json=[];

        //选中的人数
        $scope.count=0;

        //分页
        $scope.pageNumber=($scope.label_data_json.length%10)|0; //总页数
        $scope.currentPage=1;   //初始页
        $scope.perPage=10;      //每页显示的总行数


        setTimeout(function(){get_label_width('.content_list_label');},0);


        //点击返回按钮的回显
        window.post_all_label_value=function(dd){
            var temp_post = JSON.stringify(dd);
            if(dd.page!=""||dd.page!=null){
                // var temp_post={"page":1,"ids":"100007,100011,100012,100013,100014,1003,1004,1005"}
                var temp_ids=dd.ids.split(",");
                // if(temp.ids[0]==""){
                //     $scope.count=0;
                // }
                setTimeout(function(){
                    if(and){
                        $scope.count=temp_ids.length-1;
                    }else{
                        $scope.count=temp_ids.length;
                    }
                    // if(dd.page==1){
                    //     $scope.currentPage=(1);
                    //     $scope.change(1,relationType);
                    // }else{

                    // }
                        $scope.currentPage=(dd.page||1);
                        $scope.change(dd.page||1,relationType);
                    // alert(dd.page);
                    $scope.$apply();
                },0)
                for(var key in temp_ids){
                    data_json_status.push({'id':temp_ids[key]});
                }
            }
        }
        console.log(data_json_status)


        //点击切换分页
        $scope.change = function(page,relationType){
            // relationType=relationType||101;
            $scope.currentPage = page;

            //调用ajax取值回来渲染
            $scope.label_data_json=[];


            $http({
                "url":this_get_url+"/doctor/patientListWithTag/",
                // "url":"list.json",
                "method":"get",
                "params":{
                    "sceneFlag":'2',    //2表示分页，每页100条
                    "page":page,
                    "relationType":relationType,
                    'userData':this_cookie
                    // "currentPage":page,
                    // "perPage":$scope.perPage    //每页显示的条数
                }
            })
                .success(function(res){
                    //res数据结构
                    
                    // $scope.pageNumber=res.length/10==0?res.length/10:(res.length/10)|0+1;   //总页数
                    // var this_page_json = res.slice((page - 1) * $scope.perPage ,page * $scope.perPage);     //当前页面的的数据


                    // console.log(res);

                    $scope.pageNumber=res.data.pageCount;
                    var this_page_json=[];
                    for(var key in res.data.patientList){
                        this_page_json.push({
                            "id":res.data.patientList[key].id,
                            "label_src":res.data.patientList[key].portrait||'images/me_default.png',
                            "label_title":res.data.patientList[key].realname,
                            "label_address":res.data.patientList[key].address,
                            "babel_txt":res.data.patientList[key].tags,
                            "label_tick":false
                        });
                    }

                    console.log(res.data.patientList[0].portrait)
                    

                    for(var key in this_page_json){
                        for(var key_ in data_json_status){
                            if(this_page_json[key].id==data_json_status[key_].id){
                                this_page_json[key].label_tick=!this_page_json[key].label_tick
                                // this_page_json[key].label_tick=data_json_status[key_].label_tick;
                            }
                        }
                    }

                    $scope.label_data_json=this_page_json;
                    
                })
                .error(function(res){
                    console.log(res);
                });

        };
        $scope.change(1,relationType); //初始化

        //点击上一页下一页
        $scope.setChange = function(page){
            // $(document).scrollTop(0); 
            // alert('setChange='+page)
            if(page <= 0){
                $scope.currentPage = page + 1;  // 左边没有数据
            }else if(page > $scope.pageNumber){
                $scope.currentPage = page - 1;  //右边没有
            }else{
                $scope.change(page,relationType);    //中间
            }
        };

        //选中事件，显示箭头
        $scope.show_tick = function(event,index) {
            $('.label_checkbox img').eq(index).attr('src','./images/check_tick.png');
            $scope.label_data_json[index].label_tick=!$scope.label_data_json[index].label_tick;
            if($scope.label_data_json[index].label_tick){
                $scope.count++;
                data_json_status.splice($scope.label_data_json[index].id,0,{
                    'id':$scope.label_data_json[index].id,
                    'label_title':$scope.label_data_json[index].label_title,
                    'babel_txt':$scope.label_data_json[index].babel_txt,
                    'label_tick':$scope.label_data_json[index].label_tick
                });
                // console.log('add',index,$scope.label_data_checked)
            }else{
                $scope.count<=0?0:$scope.count--;
                data_json_status.splice($scope.label_data_json[index].id,2);
                // console.log('del',$scope.label_data_checked)
            }
        };

        //跳转添加标签，传值
        $scope.label_value_add=function(){

            var and = browser.versions.android;
            var ios = browser.versions.ios;

            // console.log(data_json_status)
            var pp=[];
            for(var key in data_json_status){
                pp.push(data_json_status[key].id);
            }

            console.log(pp.join(","))

            // alert($scope.currentPage)
            if($scope.count>0){
                location.href='addLabel.html?userData='+userData+'&label_value_add='+pp+'&relationType='+relationType+'&page='+$scope.currentPage+'&count='+$scope.count+'&groupsAll='+1;
            }
        }
    });
</script>
</body>

</html>